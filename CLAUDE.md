# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Important Instructions

- **Always keep this file updated** when making changes to the config
- **Always test changes** - use headless mode when possible, ask user to verify in Neovim
- **Propose changes before implementing** - discuss the plan first for non-trivial changes
- Git commits: No "Generated by Claude Code" footer or Co-Authored-By lines

## Overview

Neovim configuration originally based on kickstart.nvim, now with independent custom plugins. Main configuration in `init.lua`, modular plugin configs in `lua/custom/plugins/`.

**Design goal**: Robust Python and Rust IDE with beginner-friendly defaults and room for advanced customization.

## Code Style

- Lua files formatted with stylua (2 spaces, no parentheses on calls, Unix line endings)
- Format on save enabled via conform.nvim
- Leader key is `<space>`

## Architecture

### Plugin Management
- Uses lazy.nvim for plugin management
- Core plugins configured in `init.lua`
- **All custom plugins in `lua/custom/plugins/*.lua`** - auto-loaded via lazy's import
- Kickstart plugins in `lua/kickstart/plugins/` are **NOT used** - kept for reference only

### Key Plugin Stack

| Category | Plugin | Purpose |
|----------|--------|---------|
| **LSP** | nvim-lspconfig + mason.nvim | Language servers |
| **Completion** | blink.cmp + LuaSnip | Autocompletion |
| **Picker/UI** | Snacks.nvim | Fuzzy finder, explorer, notifications, terminal |
| **Git** | gitsigns.nvim + lazygit | Git integration |
| **Formatting** | conform.nvim | Code formatting (ruff, rustfmt, stylua, taplo) |
| **Linting** | nvim-lint | Additional linting (ruff for Python) |
| **Debugging** | nvim-dap + dap-ui | Debug Adapter Protocol |
| **Rust** | rustaceanvim + crates.nvim | Rust IDE features |
| **Python** | nvim-dap-python + venv-selector | Python IDE features |
| **Theme** | catppuccin (mocha) | Color scheme |

### LSP Servers (Mason auto-installs)
- `lua_ls` - Lua
- `pyright` - Python
- `bashls` - Bash
- `rust-analyzer` - Rust (via rustaceanvim, not in servers table)

### Formatters & Tools (Mason auto-installs)
- `stylua` - Lua
- `ruff` - Python (linting + formatting, replaces black/isort/flake8)
- `rustfmt` - Rust (via rustup, not Mason)
- `taplo` - TOML
- `shfmt` - Shell
- `debugpy` - Python debugger
- `codelldb` - Rust/C/C++ debugger

### Treesitter Parsers
`python`, `bash`, `rust`, `toml`, `ron`, `lua`, `c`, `diff`, `html`, `markdown`, `vim`, `vimdoc`

## Custom Plugins Structure

```
lua/custom/plugins/
├── autopairs.lua      # Treesitter-aware auto pairs
├── dap-python.lua     # Python debugging (debugpy)
├── debug.lua          # DAP core config (VS Code F-keys)
├── gitsigns.lua       # Git signs + hunk operations
├── lint.lua           # nvim-lint config (ruff)
├── lualine.lua        # Status line
├── mini-icons.lua     # File icons
├── noice.lua          # UI notifications
├── persistence.lua    # Session management
├── rust.lua           # rustaceanvim + crates.nvim
├── simple-zoom.lua    # Window zoom
├── snacks.lua         # Snacks.nvim config
├── tmux-navigator.lua # Tmux pane navigation
└── venv-selector.lua  # Python venv picker
```

## Keybinding Structure

### Main Groups (which-key)

| Prefix | Group | Purpose |
|--------|-------|---------|
| `<leader>b` | Buffer | Buffer operations |
| `<leader>c` | Code | Code actions, format, LSP, diagnostics |
| `<leader>d` | Debug | DAP debugging |
| `<leader>f` | Find | File/buffer finding |
| `<leader>g` | Git | Lazygit, git browse |
| `<leader>h` | Hunk | Git hunk operations |
| `<leader>p` | Python | Venv, Python debug |
| `<leader>q` | Session | Session save/restore |
| `<leader>r` | Ranger | File browser |
| `<leader>s` | Search | Grep, symbols, etc. |
| `<leader>t` | Toggle | UI toggles |
| `<leader>w` | Workspace | Workspace operations |

### Debug Keybindings (VS Code style)

| Key | Action |
|-----|--------|
| `F5` | Continue |
| `Shift+F5` | Stop |
| `F9` | Toggle Breakpoint |
| `F10` | Step Over |
| `F11` | Step Into |
| `Shift+F11` | Step Out |

Also available under `<leader>d*` prefix.

### Code Group (`<leader>c`)

| Key | Action | Notes |
|-----|--------|-------|
| `a` | Code Action | Rust-enhanced |
| `d` | Diagnostics List | |
| `D` | Render Diagnostic | Rust only |
| `e` | Explain Error | Rust only |
| `E` | Open Docs | Rust only |
| `f` | Format | |
| `l` | LSP Restart | |
| `r` | Runnables | Rust only |
| `R` | Rename File | |

### Python Group (`<leader>p`)

| Key | Action |
|-----|--------|
| `c` | Debug Test Class |
| `s` | Debug Selection |
| `t` | Debug Test Method |
| `v` | Venv Selector |

### LSP Navigation (buffer-local)

| Key | Action |
|-----|--------|
| `gd` | Go to Definition |
| `gD` | Go to Declaration |
| `gr` | References |
| `gI` | Go to Implementation |
| `gy` | Go to Type Definition |
| `K` | Hover (Rust: with actions) |
| `J` | Join Lines (Rust only) |

### Git Hunks (`<leader>h`)

| Key | Action |
|-----|--------|
| `s` | Stage hunk |
| `r` | Reset hunk |
| `S` | Stage buffer |
| `u` | Undo stage hunk |
| `R` | Reset buffer |
| `p` | Preview hunk |
| `b` | Blame line |
| `d` | Diff index |
| `D` | Diff last commit |

### Ranger Integration

`<leader>rr` opens ranger in floating terminal:
- `l` or `Enter` on file: opens in nvim
- `l` or `Enter` on directory: navigates into it
- `q`: cancels

### Special Behaviors
- `H` triggers smart quit when opened from Ranger (`RANGER_LEVEL` env var)
- Neovide has custom Cmd-key mappings for macOS

## Plugin-Specific Notes

### rustaceanvim
- Does NOT use `setup()` - configure via `vim.g.rustaceanvim` in `init` function
- Automatically sets up rust-analyzer
- Provides enhanced code actions, hover, diagnostics

### crates.nvim
- Activates on `Cargo.toml` files
- Shows crate versions, updates available
- LSP integration for completion

### nvim-dap-python
- Uses debugpy from Mason (`~/.local/share/nvim/mason/packages/debugpy/venv/bin/python`)
- Falls back to system python if not found
- Test method/class detection for pytest

## Testing Changes

### Automated Testing (Claude should do this)
Use `nvim --headless` to run tests without user interaction:

1. **Syntax check**: Load config/plugin files with `luafile` to catch Lua errors
2. **Config load**: Start nvim headless and quit to verify no startup errors
3. **Checkhealth**: Run `:checkhealth` and write output to temp file, then read it
4. **Mason packages**: Query `require('mason-registry').get_installed_package_names()`
5. **Logs**: Check `~/.local/state/nvim/log` for recent errors

Use `+"command"` syntax for headless commands (not `-c "command"`).
Write output to temp files to capture results.

### User Verification (ask user when needed)
1. Restart Neovim and check which-key shows correct groups
2. Test affected keybindings
3. For LSP: open relevant file type, verify `:LspInfo`
4. For debug: set breakpoint, start debugger
